# Java Demo

## **准备材料：** <a href="#javademo-zhun-bei-cai-liao" id="javademo-zhun-bei-cai-liao"></a>

1.  #### 一个可以成功 maven package 的 Git 工程：[https://git.code.oa.com/ci-demo/java](https://git.code.oa.com/ci-demo/java)，配置好腾讯软件源配置文件，[请参考](http://mirrors.tencent.com/#/document/maven)。将 settings.xml 文件置入根目录： <a href="#javademo-yi-ge-ke-yi-cheng-gong-mavenpackage-de-git-gong-cheng-httpsgit.code.oa.comcidemojava-pei-zh" id="javademo-yi-ge-ke-yi-cheng-gong-mavenpackage-de-git-gong-cheng-httpsgit.code.oa.comcidemojava-pei-zh"></a>

    | `<?xml` `version="1.0"` `encoding="UTF-8"?><settings>    <offline>false</offline>    <profiles>        <profile>            <id>tencent</id>            <repositories>                <repository>                    <id>tencent</id>                    <url>`[`https://mirrors.tencent.com/nexus/repository/maven-public/`](https://mirrors.tencent.com/nexus/repository/maven-public/)`</url>                    <releases>                        <enabled>true</enabled>                    </releases>                    <snapshots>                        <enabled>false</enabled>                    </snapshots>                </repository>            </repositories>` `<pluginRepositories>                <pluginRepository>                    <id>tencent</id>                    <url>`[`https://mirrors.tencent.com/nexus/repository/maven-public/`](https://mirrors.tencent.com/nexus/repository/maven-public/)`</url>                    <releases>                        <enabled>true</enabled>                    </releases>                    <snapshots>                        <enabled>false</enabled>                    </snapshots>                </pluginRepository>            </pluginRepositories>        </profile>        <profile>            <id>devops</id>            <activation>                <activeByDefault>true</activeByDefault>            </activation>` `<repositories>                <repository>                    <id>devops</id>                    <url>`[`http://mirrors.devops.oa.com/maven/`](http://mirrors.devops.oa.com/maven/)`</url>                    <releases>                        <enabled>true</enabled>                    </releases>                    <snapshots>                        <enabled>true</enabled>                    </snapshots>                </repository>` `<repository>                    <id>devops-snapshots</id>                    <url>`[`http://mirrors.devops.oa.com/maven-snapshots/`](http://mirrors.devops.oa.com/maven-snapshots/)`</url>                    <releases>                        <enabled>false</enabled>                    </releases>                    <snapshots>                        <enabled>true</enabled>                    </snapshots>                </repository>            </repositories>            <pluginRepositories>                <pluginRepository>                    <id>devops</id>                    <url>`[`http://mirrors.devops.oa.com/maven/`](http://mirrors.devops.oa.com/maven/)`</url>                    <releases>                        <enabled>true</enabled>                    </releases>                    <snapshots>                        <enabled>false</enabled>                    </snapshots>                </pluginRepository>` `<pluginRepository>                    <id>devops-snapshots</id>                    <url>`[`http://mirrors.devops.oa.com/maven-snapshots/`](http://mirrors.devops.oa.com/maven-snapshots/)`</url>                    <releases>                        <enabled>false</enabled>                    </releases>                    <snapshots>                        <enabled>true</enabled>                    </snapshots>                </pluginRepository>            </pluginRepositories>        </profile>    </profiles>    <activeProfiles>        <activeProfile>tencent</activeProfile>    </activeProfiles>    <servers>        <server>            <id>{{TEAM_GK}}-{{PROJECT_NAME}}-{{REPO_NAME}}</id>            <!--OA账号名、页面获取的令牌-->            <username>{{MAVEN_USERNAME}}</username>            <password>{{MAVEN_TOKEN}}</password>        </server>    </servers> </settings>` |
    | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
2. #### 一个已存在的腾讯软件源 [maven 仓库](http://mirrors.tencent.com/#/private/maven) <a href="#javademo-yi-ge-yi-cun-zai-de-teng-xun-ruan-jian-yuan-maven-cang-ku" id="javademo-yi-ge-yi-cun-zai-de-teng-xun-ruan-jian-yuan-maven-cang-ku"></a>

## **详细步骤:** <a href="#javademo-xiang-xi-bu-zhou" id="javademo-xiang-xi-bu-zhou"></a>

### **1. 将代码库关联至蓝盾，**[**请参考**](http://iwiki.oa.com/pages/viewpage.action?pageId=10718809) <a href="#javademo1.-jiang-dai-ma-ku-guan-lian-zhi-lan-dun-qing-can-kao" id="javademo1.-jiang-dai-ma-ku-guan-lian-zhi-lan-dun-qing-can-kao"></a>

### **2. 创建一条空流水线，**[**请参考**](http://iwiki.oa.com/pages/viewpage.action?pageId=10718801) <a href="#javademo2.-chuang-jian-yi-tiao-kong-liu-shui-xian-qing-can-kao" id="javademo2.-chuang-jian-yi-tiao-kong-liu-shui-xian-qing-can-kao"></a>

### **3. 添加2-1的** [**Linux Job**](http://iwiki.oa.com/pages/viewpage.action?pageId=10718789)**，选择 “tlinux2.2” docker 镜像** <a href="#javademo3.-tian-jia-21-de-linuxjob-xuan-ze-tlinux2.2docker-jing-xiang" id="javademo3.-tian-jia-21-de-linuxjob-xuan-ze-tlinux2.2docker-jing-xiang"></a>

### **4. 构建环境中配置 maven 依赖编译环境** <a href="#javademo4.-gou-jian-huan-jing-zhong-pei-zhi-maven-yi-lai-bian-yi-huan-jing" id="javademo4.-gou-jian-huan-jing-zhong-pei-zhi-maven-yi-lai-bian-yi-huan-jing"></a>

![](<../../.gitbook/assets/image (31) (1).png>)

### **5. 在 Job 内以此添加如下插件** <a href="#javademo5.-zai-job-nei-yi-ci-tian-jia-ru-xia-cha-jian" id="javademo5.-zai-job-nei-yi-ci-tian-jia-ru-xia-cha-jian"></a>

#### 5.1 [拉取Git（命令行）](http://devops.oa.com/console/store/atomStore/detail/atom/gitCodeRepo)：将 maven 工程拉取到 Linux Job 内  <a href="#javademo5.1-la-qu-git-ming-ling-hang-jiang-maven-gong-cheng-la-qu-dao-linuxjob-nei" id="javademo5.1-la-qu-git-ming-ling-hang-jiang-maven-gong-cheng-la-qu-dao-linuxjob-nei"></a>

![](<../../.gitbook/assets/image (22).png>)

#### 5.2 [Bash](http://docs.devops.oa.com/%E6%89%80%E6%9C%89%E6%9C%8D%E5%8A%A1/%E6%B5%81%E6%B0%B4%E7%BA%BF/%E7%94%A8%E6%88%B7%E6%8C%87%E5%8D%97/%E6%8F%92%E4%BB%B6%E5%88%97%E8%A1%A8/script.html)：替换 TEAM\_GK、PROJECT\_NAME、REPO\_NAME、MAVEN\_USER\_NAME、MAVEN\_TOKEN，将构件部署至腾讯软件源 <a href="#javademo5.2bash-ti-huan-teamgkprojectnamereponamemavenusernamemaventoken-jiang-gou-jian-bu-shu-zhi-t" id="javademo5.2bash-ti-huan-teamgkprojectnamereponamemavenusernamemaventoken-jiang-gou-jian-bu-shu-zhi-t"></a>

![](<../../.gitbook/assets/image (25) (1).png>)

| `mvn package` `sed` `-i 's/{{TEAM_GK}}/devops/'` `settings.xmlsed` `-i 's/{{PROJECT_NAME}}/demo/'` `settings.xmlsed` `-i 's/{{REPO_NAME}}/mavendemo/'` `settings.xmlsed` `-i 's/{{MAVEN_USERNAME}}/xxxxxx/'` `settings.xmlsed` `-i 's/{{MAVEN_TOKEN}}/xxxxxx/'` `settings.xml` `mv` `settings.xml ~/.m2` `cat` `~/.m2/settings.xml` `mvn deploy:deploy-file` `-Dfile=${WORKSPACE}/target/demo-0.0.1-SNAPSHOT.jar -DgroupId=devops -DartifactId=demo -Dversion=0.0.1-SNAPSHOT -Dpackaging=jar -DrepositoryId=devops-demo-mavendemo -Durl=https://mirrors.tencent.com/repository/maven/mavendemo/` |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |

\


### **6. 运行流水线，观察结果** <a href="#javademo6.-yun-hang-liu-shui-xian-guan-cha-jie-guo" id="javademo6.-yun-hang-liu-shui-xian-guan-cha-jie-guo"></a>

![](<../../.gitbook/assets/image (29) (1).png>)

### **7. 到腾讯软件源的**[**Maven内部组件仓库**](http://mirrors.tencent.com/#/private/maven)**确认构件是否推送成功** <a href="#javademo7.-dao-teng-xun-ruan-jian-yuan-de-maven-nei-bu-zu-jian-cang-ku-que-ren-gou-jian-shi-fou-tui" id="javademo7.-dao-teng-xun-ruan-jian-yuan-de-maven-nei-bu-zu-jian-cang-ku-que-ren-gou-jian-shi-fou-tui"></a>

![](<../../.gitbook/assets/image (14) (1).png>)
